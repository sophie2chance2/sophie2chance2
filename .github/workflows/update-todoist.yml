name: Todoist Readme

on:
  workflow_dispatch:
  schedule:
    # Runs every 5 hours
    - cron: "0 */5 * * *"

jobs:
  update-readme:
    name: Update this repo's README
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Update Todoist Stats
        env:
          TODOIST_API_KEY: ${{ secrets.TODOIST_API_KEY }}
        run: |
          python3 << 'EOF'
          import os, json, re, urllib.request

          token = os.environ['TODOIST_API_KEY']
          headers = {'Authorization': f'Bearer {token}'}

          def fetch(url):
              req = urllib.request.Request(url, headers=headers)
              with urllib.request.urlopen(req) as r:
                  return json.loads(r.read())

          stats = fetch('https://api.todoist.com/api/v1/tasks/completed/stats')

          karma           = stats.get('karma', 0)
          completed_count = stats.get('completedCount', 0)
          days_items      = stats.get('daysItems', [])
          today           = days_items[0].get('totalCompleted', 0) if days_items else 0
          goals           = stats.get('goals', {})
          max_streak      = goals.get('maxDailyStreak', {})
          longest         = max_streak.get('count', 0) if isinstance(max_streak, dict) else 0

          lines = [
              f'ðŸ†  {karma:,} Karma Points',
              f'ðŸŒ¸  Completed {today} tasks today',
              f'âœ…  Completed {completed_count:,} tasks so far',
              f'â³  Longest streak is {longest} days',
          ]
          new_block = '<!-- TODO-IST:START -->\n' + '           \n'.join(lines) + '\n<!-- TODO-IST:END -->'

          with open('README.md', 'r') as f:
              readme = f.read()

          updated = re.sub(r'<!-- TODO-IST:START -->.*?<!-- TODO-IST:END -->', new_block, readme, flags=re.DOTALL)

          if updated != readme:
              with open('README.md', 'w') as f:
                  f.write(updated)
              print('README updated')
          else:
              print('No changes detected')
          EOF
      - name: Commit and push
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add README.md
          git diff --cached --quiet && echo "No changes to commit" || \
            (git commit -m "Todoist updated." && git push)
